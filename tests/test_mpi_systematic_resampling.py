import autograd.numpy as np
from mpi4py import MPI

from smccomponents.resample.systematic.mpi import resample as systematic_resample


if __name__ == "__main__":
    x = np.array([[-0.62261004, -1.08320464,  0.76744037, -1.18659168],
                [ 0.52337696,  0.71712472,  0.95038028,  0.17819749],
                [-3.47854328,  0.15926688,  0.76711163,  1.27139163],
                [-0.43610397, -0.59009208,  0.10328656, -0.11491373],
                [ 0.35982562, -3.53590449,  1.02422938,  0.84456352],
                [-0.19217198, -0.05887353, -1.90326743,  0.99870704],
                [ 1.73326319, -0.4261406 , -0.06112357, -0.2267804 ],
                [-0.52304888,  1.37736236,  0.35274196, -0.5168925 ],
                [ 0.46369562,  0.15225607, -1.0770983 , -0.36117729],
                [ 0.82698694,  0.01785293,  0.49016855, -0.38935393],
                [ 2.06507424,  0.85389496,  0.54539218,  0.31148988],
                [ 0.67126736, -1.44816102, -0.6193303 ,  0.11968442],
                [ 1.99442073,  0.82982206, -0.3704614 , -1.25044962],
                [ 0.507177  , -0.41876195,  1.50650932, -0.9684984 ],
                [-0.28702499, -0.06174435,  1.11309015,  0.51198948],
                [-0.28681373,  0.6211365 ,  1.41271302, -0.30726438]])

    wn = np.array([1.64481232e-145, 2.91394611e-037, 3.38261878e-138, 2.62691290e-045,
                1.22535991e-312, 0.00000000e+000, 6.47073921e-271, 1.00000000e+000,
                0.00000000e+000, 4.03512349e-024, 3.88356108e-086, 0.00000000e+000,
                0.00000000e+000, 0.00000000e+000, 0.00000000e+000, 0.00000000e+000])

    # wn = np.array([1.64481232e-145, 2.91394611e-037, 3.38261878e-138, 2.62691290e-045,
    #             1.22535991e-312, 0.00000000e+000, 0.5, 
    #             0.00000000e+000, 4.03512349e-024, 3.88356108e-086, 0.00000000e+000,
    #             0.00000000e+000, 0.5, 0.00000000e+000, 0.00000000e+000, 0.00000000e+000])

    log_likelihood = 0
    
    comm = MPI.COMM_WORLD

    N = len(x)
    N_local = N // comm.Get_size()

    _x = x[comm.Get_rank() * N_local : (comm.Get_rank() + 1) * N_local]
    _wn = wn[comm.Get_rank() * N_local : (comm.Get_rank() + 1) * N_local]

    _x_new, _logw_new = systematic_resample.resample(_x, _wn, N, N_local, comm)

    print(_x_new)
    print(_logw_new)

    MPI.Finalize()
